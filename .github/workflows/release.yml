name: release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      ext: tar.gz
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      ext: tar.gz
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      ext: tar.gz
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      ext: zip
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v6
            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}
            - uses: Swatinem/rust-cache@v2
              with:
                  key: release-${{ matrix.target }}
                  cache-on-failure: true
            - name: Build
              run: cargo build --release --locked --target ${{ matrix.target }}
            - name: Package (unix)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                  NAME="at-${{ matrix.target }}"
                  mkdir -p dist
                  cp "target/${{ matrix.target }}/release/at" "dist/${NAME}"
                  tar -C dist -czf "${NAME}.tar.gz" "${NAME}"
            - name: Package (windows)
              if: runner.os == 'Windows'
              shell: bash
              run: |
                  NAME="at-${{ matrix.target }}"
                  mkdir -p dist
                  cp "target/${{ matrix.target }}/release/at.exe" "dist/${NAME}.exe"
                  cd dist
                  7z a "../${NAME}.zip" "${NAME}.exe"
            - name: Upload assets
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      at-${{ matrix.target }}.${{ matrix.ext }}
