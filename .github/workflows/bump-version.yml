name: bump-version

on:
    push:
        branches:
            - main
        paths-ignore:
            - ".github/**"
            - "docs/**"
            - "**/*.md"

permissions:
    contents: write

jobs:
    bump:
        if: "!contains(github.event.head_commit.message, 'chore(release):')"
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.PAT_TOKEN }}
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
            - name: Bump version
              run: |
                  python3 scripts/bump-version.py patch > /tmp/version.txt
            - name: Update Cargo.lock
              run: cargo update --workspace
            - name: Commit and tag
              run: |
                  VERSION=$(cat /tmp/version.txt)
                  git add Cargo.toml Cargo.lock package.json
                  git restore --staged benchmarks/ || true
                  git commit -m "chore(release): bump version to ${VERSION}"
                  git tag -d "v${VERSION}" || true
                  git tag "v${VERSION}"
            - name: Push changes
              run: |
                  git pull --rebase origin main
                  git push origin main
            - name: Push tags
              run: |
                  VERSION=$(cat /tmp/version.txt)
                  git push origin "refs/tags/v${VERSION}" --force
