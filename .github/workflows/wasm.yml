name: wasm

on:
    push:
        branches:
            - main
        tags:
            - "v*"
    pull_request:
    workflow_dispatch:

jobs:
    build-wasm:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown
            - uses: Swatinem/rust-cache@v2
            - name: Install wasm-pack
              run: cargo install wasm-pack
            - name: Run WASM crate tests
              run: cargo test -p at_wasm
            - name: Cargo wasm target smoke
              run: cargo build -p at_wasm --target wasm32-unknown-unknown
            - name: Build wasm bundle
              run: wasm-pack build crates/at_wasm --target web

    publish-npm:
        runs-on: ubuntu-latest
        needs: build-wasm
        if: startsWith(github.ref, 'refs/tags/v')
        steps:
            - uses: actions/checkout@v4
            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown
            - uses: Swatinem/rust-cache@v2
            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  registry-url: https://registry.npmjs.org
            - name: Install wasm-pack
              run: cargo install wasm-pack
            - name: Build wasm bundle
              run: npm ci && npm run build:wasm
            - name: Publish to npm
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: npm publish --access public
